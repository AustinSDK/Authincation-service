<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth Applications</title>
    <link rel="stylesheet" href="/css/main.css">
    <script src="/js/oauth.js"></script>
</head>
<body>
    <%- include('partials/nav', { user: user }) %>
    <main class="container"> 
        <header>
            <h1>OAuth Applications</h1>
            <p class="muted" style="margin-top:.5rem;">Manage OAuth applications and client credentials.</p>
            <div style="margin-top:1rem;">
                <a href="/oauth/create" class="btn btn-accent">Create Application</a>
            </div>
        </header>
        <section>
            <h2 style="margin-top:2.25rem;">Your Applications</h2>
            <ul class="list">
                <% applications.forEach(element => { %>
                    <li class="project-card" data-application-id="<%= element.id %>">
                        <a class="title" href="/oauth/<%= element.id %>"><%= element.name %></a>
                        <div class="muted"><%= element.description %></div>
                        <div class="muted" style="margin-top: 0.5rem;">
                            <strong>Client ID:</strong> <%= element.client_id %>
                        </div>
                        <div class="muted">
                            <strong>Redirect URIs:</strong> <%= element.redirect_uris.join(', ') %>
                        </div>
                        <div class="actions">
                            <a class="btn btn-ghost small act-delete" href="#" data-action="delete" data-id="<%= element.id %>">Delete</a>
                            <a class="btn btn-ghost small act-modify" href="#" data-action="modify" data-id="<%= element.id %>">Modify</a>
                        </div>
                    </li>
                <% }) %>
            </ul>
        </section>
        
        <section>
            <h2 style="margin-top:2.25rem;">Connected Applications</h2>
            <p class="muted" style="margin-bottom:1rem;">Applications you've granted access to your account.</p>
            <% if (connectedApps.length > 0) { %>
                <ul class="list">
                    <% connectedApps.forEach(element => { %>
                        <li class="project-card" data-connected-app="<%= element.client_id %>">
                            <div class="title"><%= element.name %></div>
                            <div class="muted"><%= element.description %></div>
                            <div class="muted" style="margin-top: 0.5rem;">
                                <strong>Active Tokens:</strong> <%= element.active_tokens %>
                            </div>
                            <div class="muted">
                                <strong>Scopes:</strong> <%= element.scopes.join(', ') || 'None' %>
                            </div>
                            <div class="muted">
                                <strong>Last Activity:</strong> <%= new Date(element.last_expires).toLocaleDateString() %>
                            </div>
                            <div class="actions">
                                <button class="btn btn-ghost small btn-revoke" data-client-id="<%= element.client_id %>">Revoke Access</button>
                            </div>
                        </li>
                    <% }) %>
                </ul>
            <% } else { %>
                <div class="muted" style="padding: 2rem; text-align: center; border: 1px dashed #ccc; border-radius: 4px;">
                    No connected applications found.
                </div>
            <% } %>
        </section>
    </main>
</body>
<script>
// Delegate actions to avoid inline JS issues
document.addEventListener('click', function(e){
    const target = e.target.closest('[data-action]');
    if(!target) return;
    e.preventDefault();
    const id = parseInt(target.getAttribute('data-id'),10);
    if(target.dataset.action === 'delete' && typeof _delete === 'function') {
        _delete(id);
    } else if(target.dataset.action === 'modify' && typeof _modify === 'function') {
        _modify(id);
    }
});

// Handle revoke access buttons
document.addEventListener('click', function(e){
    if(e.target.classList.contains('btn-revoke')) {
        e.preventDefault();
        const clientId = e.target.getAttribute('data-client-id');
        const appName = e.target.closest('.project-card').querySelector('.title').textContent;
        
        if(confirm(`Are you sure you want to revoke access for "${appName}"? This will invalidate all active tokens.`)) {
            revokeAccess(clientId, e.target.closest('.project-card'));
        }
    }
});

async function revokeAccess(clientId, cardElement) {
    try {
        const response = await fetch('/oauth/revoke', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ client_id: clientId })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            // Remove the card from the DOM
            cardElement.remove();
            alert(result.message);
        } else {
            alert('Error: ' + result.message);
        }
    } catch (error) {
        alert('Error revoking access: ' + error.message);
    }
}
</script>
</html>